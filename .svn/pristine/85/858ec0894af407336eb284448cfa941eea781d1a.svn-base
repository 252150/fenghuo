package com.wanjia.infoshopmallmanage.service;

import com.alibaba.fastjson.JSONObject;
import com.wanjia.infoshopmallmanage.entity.LogisticsCompany;
import com.wanjia.infoshopmallmanage.mapper.LogisticsCompanyMapper;
import com.wanjia.infoshopmallmanage.util.HttpUtil;
import com.wanjia.infoshopmallmanage.util.RestResponse;
import lombok.extern.slf4j.Slf4j;
import org.apache.http.HttpResponse;
import org.apache.http.util.EntityUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * @author: wlj
 * @date: 2020/9/27 16:48
 * @version: 1.0
 */
@Slf4j
@Service
public class BaseService {
    @Autowired
    private LogisticsCompanyMapper logisticsCompanyMapper;
    /**
     * 维护物流公司
     */
    public void maintenanceLogisticsCompany(){
        String host = "http://wuliu.market.alicloudapi.com";
        String path = "/getExpressList";
        Map<String,String> headers = new HashMap<>(1);
        String appcode = "32d5823b74d44442b1e5f28d764331ae";
        headers.put("Authorization","APPCODE " + appcode);
        try {
            HttpResponse response = HttpUtil.doGet(host,path,null,headers,null);
            String json = EntityUtils.toString(response.getEntity());
            JSONObject jsonObject = JSONObject.parseObject(json);
            Map<String,String> map = (Map<String, String>) jsonObject.get("result");
            Iterator<Map.Entry<String, String>> entries = map.entrySet().iterator();
            while(entries.hasNext()){
                Map.Entry<String, String> entry = entries.next();
                LogisticsCompany logisticsCompany = new LogisticsCompany();

                String key = entry.getKey();
                String value = entry.getValue();
                logisticsCompany.setExpressCode(key);
                logisticsCompany.setExpressName(value);
                if(logisticsCompanyMapper.selectByCode(key) == null){
                    logisticsCompanyMapper.insert(logisticsCompany);
                }
            }
        } catch (IOException ioException) {
            ioException.printStackTrace();
        }
        catch (Exception e){
            e.printStackTrace();
        }
    }

    /**
     * 获取物流公司
     * @return
     */
    public RestResponse getLogisticsCompany(){
        List<LogisticsCompany> list = logisticsCompanyMapper.selectAll();
        return RestResponse.ok("查询成功",list);
    }
}
