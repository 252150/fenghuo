package com.wanjia.infoshopmallmanage.service;


import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;

import com.wanjia.infoshopmallmanage.entity.Admin;
import com.wanjia.infoshopmallmanage.entity.UploadDto;
import com.wanjia.infoshopmallmanage.entity.User;
import com.wanjia.infoshopmallmanage.entity.Warningmsg;
import com.wanjia.infoshopmallmanage.mapper.AdminMapper;
import com.wanjia.infoshopmallmanage.mapper.UserMapper;
import com.wanjia.infoshopmallmanage.mapper.WarningmsgMapper;
import com.wanjia.infoshopmallmanage.util.DateUtils;
import com.wanjia.infoshopmallmanage.util.FileuploadUtil;
import com.wanjia.infoshopmallmanage.util.RestResponse;
import com.wanjia.infoshopmallmanage.util.StringUtil;


@Service
public class WarningmsgService {
	@Autowired
    public WarningmsgMapper warningmsgMapper;
	@Autowired
	public AdminMapper     adminMapper;
	@Autowired
	public FileuploadUtil fileuploadUtil;
	@Autowired
	public UserMapper userMapper;
	/**
	 * 灾害信息新增
	 * @param ws 实体类
	 * @param adminId 管理员id
	 * @param userName 当前用户名
	 * @return
	 */
	public RestResponse add(Warningmsg ws, Long adminId) {
		Admin admin=adminMapper.queryById(adminId);
		User user =userMapper.queryById(admin.getUserId());
		ws.setAdminId(adminId);
	     //判断是不是管理员用户
		if(!StringUtil.isNotEmpty(admin))
		{
		return RestResponse.fail("新增失败，该用户不是管理员用户");
		}
		//灾害发生时间
		ws.setCreateTime(DateUtils.currentTime());
		//上传灾害图片
		List<UploadDto> list=fileuploadUtil.uploadBatchFile(ws.getMessImageMultipartFile(), user.getUsername());
		String imgs="";
		//图片组装
		for (UploadDto uploadDto2 : list) {
			imgs+=uploadDto2.getImgName()+",";
		}
		ws.setMessImage(imgs);	
	
		//组装链接
		ws.setMessVidio(fileuploadUtil.upload(ws.getMessVidioMultipartFile(), user.getUsername()));
		//新增灾害信息
		int num=warningmsgMapper.insert(ws);
		if(num>0) {
			return RestResponse.ok("成功");
		}else {
			return RestResponse.fail("新增失败。服务器问题");
		}

	}
	/**
	 * 修改灾害信息
	 * @param ws 实体类
	 * @param adminId 用户id
	 * @param userName 用户名
	 * @return
	 */
	public RestResponse update (Warningmsg ws,Long adminId) {
		
		Admin admin=adminMapper.queryById(adminId);
		User user =userMapper.queryById(admin.getUserId());
		ws.setAdminId(adminId);
		if(admin.getId()==null) {
			return RestResponse.fail("新增失败，该用户不是管理员用户");
		}
		//根据灾害ID查出信息
		Warningmsg warningmsg=warningmsgMapper.queryById(ws.getId());
		//判断灾害图片是否拥有
		if(warningmsg.getMessImage()!=null&&!"".equals(warningmsg.getMessImage())) {
		
			String []imgs=warningmsg.getMessImage().split(",");
			//删除灾害图片
			for (int i = 0; i < imgs.length; i++) {
				
				fileuploadUtil.removeFile(fileuploadUtil.fileName(imgs[i]));
			}
			

		}
		//删除视频图片
		if(warningmsg.getMessVidio()!=null&&warningmsg.getMessVidio()!="") {
			fileuploadUtil.removeFile(fileuploadUtil.makeFileName(warningmsg.getMessVidio()));
		}
		//修改过后的时间
		ws.setCreateTime(DateUtils.currentTime());
		//上传灾害图片
		List<UploadDto> list=fileuploadUtil.uploadBatchFile(ws.getMessImageMultipartFile(), user.getUsername());
		String imgs="";
		//图片组装
		for (UploadDto uploadDto2 : list) {
			imgs+=uploadDto2.getImgName()+",";
		}
		ws.setMessImage(imgs);	
		//组装链接
		ws.setMessVidio(fileuploadUtil.upload(ws.getMessVidioMultipartFile(), user.getUsername()));
		int num=warningmsgMapper.update(ws);
		if(num>0) {
			return RestResponse.ok("成功");
		}else {
			return RestResponse.fail("新增失败。服务器问题");
		}
	}
    /**
     * 灾害消息删除
     * @param adminId 用户id
     * @param id 灾害id
     * @param userName 用户名
     * @return
     */
	public RestResponse delete (Long adminId,Long id ) {
		
		
		Admin admin=adminMapper.queryById(adminId);
		if(admin.getId()==null) {
			return RestResponse.fail("删除失败，该用户不是管理员用户");
		}
		//根据灾害ID查出信息
		Warningmsg warningmsg=warningmsgMapper.queryById(id);
		//判断灾害图片是否拥有
		if(warningmsg.getMessImage()!=null&&!"".equals(warningmsg.getMessImage())) {
		
			String []imgs=warningmsg.getMessImage().split(",");
			//删除灾害图片
			for (int i = 0; i < imgs.length; i++) {
				
				fileuploadUtil.removeFile(fileuploadUtil.fileName(imgs[i]));
			}
			

		}
		//删除视频文件
		if(warningmsg.getMessVidio()!=null&&warningmsg.getMessVidio()!="") {
			fileuploadUtil.removeFile(fileuploadUtil.makeFileName(warningmsg.getMessVidio()));
		}
		//删除信息
		int num=warningmsgMapper.deleteById(id);
		if(num>0) {
			return RestResponse.ok("成功");
		}else {
			return RestResponse.fail("新增失败。服务器问题");
		}
	}
	/**
	 * 灾害信息获取
	 * @param userName
	 * @return
	 */
	
	public RestResponse list(Warningmsg ws) {
		PageHelper.startPage(ws.getPageNo(),20);
		Admin admin=adminMapper.queryById(ws.getAdminId());
	     //判断是不是管理员用户
		if(StringUtil.isNotEmpty(admin))
		{
		return RestResponse.fail("获取失败，该用户不是管理员用户");
		}
		//返回集合
		List<Warningmsg> list=	warningmsgMapper.queryAll(ws);
		PageInfo<Warningmsg> page = new PageInfo<Warningmsg>(list);
		return RestResponse.ok("成功",page);
	}

}
